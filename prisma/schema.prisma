// Prisma schema for WiFi Billing System
// Edit the DATABASE_URL in .env before running migrations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Admin {
  id       Int    @id @default(autoincrement())
  email    String @unique
  password String
}

model User {
  id            Int      @id @default(autoincrement())
  phone         String   @unique
  macAddress    String
  status        String
  currentPackage String? 
  expiresAt     DateTime?
  totalSpent    Int      @default(0)
  sessionsCount Int      @default(0)
  lastSeen      DateTime?
  payments      Payment[]
}

model Payment {
  id            Int      @id @default(autoincrement())
  phone         String
  amount        Int
  transactionId String   @unique
  macAddress    String
  status        String
  timePurchased DateTime @default(now())
  mpesaRef      String?  @unique
  expiresAt     DateTime?
  userId        Int?
  user          User?    @relation(fields: [userId], references: [id])

  @@index([mpesaRef])
  @@index([transactionId])
}

model ClientLicense {
  id              Int      @id @default(autoincrement())
  clientName      String
  licenseKey      String   @unique
  status          String   // "active", "expired", "suspended"
  monthlyAmount   Int      @default(2000) // Monthly fee in KES
  userLimit       Int      @default(300)  // Maximum users allowed
  currentUserCount Int     @default(0)    // Current active users
  issueDate       DateTime @default(now())
  expiresAt       DateTime
  autoRenew       Boolean  @default(false)
  contactPhone    String?
  contactEmail    String?
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  licensePayments LicensePayment[]

  @@index([status])
  @@index([expiresAt])
}

model LicensePayment {
  id            Int      @id @default(autoincrement())
  licenseId     Int
  license       ClientLicense @relation(fields: [licenseId], references: [id])
  amount        Int
  transactionId String   @unique
  mpesaRef      String?  @unique
  status        String   // "pending", "completed", "failed"
  paymentDate   DateTime @default(now())
  periodStart   DateTime
  periodEnd     DateTime
  createdAt     DateTime @default(now())

  @@index([licenseId])
  @@index([transactionId])
}

model SupportRequest {
  id        Int      @id @default(autoincrement())
  phone     String
  message   String
  createdAt DateTime @default(now())
}
